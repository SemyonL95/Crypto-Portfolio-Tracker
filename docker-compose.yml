version: '3.8'

services:
  # Main application service
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crypto-portfolio-tracker
    ports:
      - "${SERVER_PORT:-8080}:${SERVER_PORT:-8080}"
    environment:
      # Server configuration
      - SERVER_HOST=${SERVER_HOST:-}
      - SERVER_PORT=${SERVER_PORT:-8080}
      - SERVER_READ_TIMEOUT=${SERVER_READ_TIMEOUT:-15s}
      - SERVER_WRITE_TIMEOUT=${SERVER_WRITE_TIMEOUT:-15s}
      - SERVER_IDLE_TIMEOUT=${SERVER_IDLE_TIMEOUT:-60s}
      # Price service configuration
      - PRICE_PROVIDER=${PRICE_PROVIDER:-coingecko}
      - PRICE_CACHE_TTL=${PRICE_CACHE_TTL:-60s}
      - PRICE_REQUEST_TIMEOUT=${PRICE_REQUEST_TIMEOUT:-10s}
      - PRICE_RATE_LIMIT_RPS=${PRICE_RATE_LIMIT_RPS:-10}
      - PRICE_FALLBACK_ENABLED=${PRICE_FALLBACK_ENABLED:-true}
      - COINGECKO_API_KEY=${COINGECKO_API_KEY:-}
      - COINGECKO_BASE_URL=${COINGECKO_BASE_URL:-https://api.coingecko.com/api/v3}
      # Transaction service configuration
      - TRANSACTION_PROVIDER=${TRANSACTION_PROVIDER:-etherscan}
      - TRANSACTION_REQUEST_TIMEOUT=${TRANSACTION_REQUEST_TIMEOUT:-10s}
      - TRANSACTION_RATE_LIMIT_RPS=${TRANSACTION_RATE_LIMIT_RPS:-5}
      - ETHERSCAN_API_KEY=${ETHERSCAN_API_KEY:-}
      - ETHERSCAN_BASE_URL=${ETHERSCAN_BASE_URL:-https://api.etherscan.io/api}
      # Database configuration
      - DB_PATH=/data/portfolio.db
      # Application configuration
      - APP_ENV=${APP_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - TOKENS_PATH=/root/static/tokens.json
    volumes:
      - ./static:/root/static:ro
      - ./data:/data
      - ./migrations:/root/migrations:ro
      - ./scripts:/root/scripts:ro
    restart: unless-stopped

  # Debug service with Delve debugger
  app-debug:
    build:
      context: .
      dockerfile: Dockerfile.debug
    container_name: crypto-portfolio-tracker-debug
    ports:
      - "${SERVER_PORT:-8080}:${SERVER_PORT:-8080}"  # Application port
      - "2345:2345"  # Delve debugger port
    environment:
      # Server configuration
      - SERVER_HOST=${SERVER_HOST:-}
      - SERVER_PORT=${SERVER_PORT:-8080}
      - SERVER_READ_TIMEOUT=${SERVER_READ_TIMEOUT:-15s}
      - SERVER_WRITE_TIMEOUT=${SERVER_WRITE_TIMEOUT:-15s}
      - SERVER_IDLE_TIMEOUT=${SERVER_IDLE_TIMEOUT:-60s}
      # Price service configuration
      - PRICE_PROVIDER=${PRICE_PROVIDER:-coingecko}
      - PRICE_CACHE_TTL=${PRICE_CACHE_TTL:-60s}
      - PRICE_REQUEST_TIMEOUT=${PRICE_REQUEST_TIMEOUT:-10s}
      - PRICE_RATE_LIMIT_RPS=${PRICE_RATE_LIMIT_RPS:-10}
      - PRICE_FALLBACK_ENABLED=${PRICE_FALLBACK_ENABLED:-true}
      - COINGECKO_API_KEY=${COINGECKO_API_KEY:-}
      - COINGECKO_BASE_URL=${COINGECKO_BASE_URL:-https://api.coingecko.com/api/v3}
      # Transaction service configuration
      - TRANSACTION_PROVIDER=${TRANSACTION_PROVIDER:-etherscan}
      - TRANSACTION_REQUEST_TIMEOUT=${TRANSACTION_REQUEST_TIMEOUT:-10s}
      - TRANSACTION_RATE_LIMIT_RPS=${TRANSACTION_RATE_LIMIT_RPS:-5}
      - ETHERSCAN_API_KEY=${ETHERSCAN_API_KEY:-}
      - ETHERSCAN_BASE_URL=${ETHERSCAN_BASE_URL:-https://api.etherscan.io/api}
      # Database configuration
      - DB_PATH=/data/portfolio.db
      # Application configuration
      - APP_ENV=${APP_ENV:-development}
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      - TOKENS_PATH=/root/static/tokens.json
    volumes:
      - ./static:/root/static:ro
      - ./data:/data
      - ./migrations:/root/migrations:ro
      - ./scripts:/root/scripts:ro
      - .:/app:ro  # Mount source code for source-level debugging
    restart: unless-stopped

